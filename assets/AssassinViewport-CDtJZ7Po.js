import{n as Z}from"./TheIslandNavbar-DFYHLj8z.js";import{u as F,r as u,z as ee,j as A,l as se,k as te,D as oe,c as n,b as o,d as R,w as I,p as H,h as T,x as ae,t as i,F as x,e as B,o as l,_ as U,f as $,g as O}from"./index-C5dtlzIh.js";const ne={class:"assassination-wrap"},le={class:"header"},ie={class:"controls"},re={class:"field"},ce={class:"field"},ue=["disabled"],de={key:0},fe={key:1},me={class:"poll"},_e={key:0,class:"status error"},pe={key:1,class:"status"},he={key:2,class:"status ok"},ye={key:0,class:"effects"},ve={class:"section-title"},we={class:"bullets"},Ae={class:"section"},be={key:0,class:"empty"},ge={class:"grid"},Ee={class:"card-head"},Re={class:"card-title"},Ne={class:"pill"},Se={class:"name"},ke={key:0,class:"pill locked"},Ce={key:1,class:"pill ready"},Ie={class:"actions"},Te=["onClick","disabled","title"],Me={key:0},Pe={key:1},Le=["onClick","disabled"],He={key:0,class:"lock-hint"},xe={key:1,class:"preview"},Be={class:"section"},$e={class:"table-wrap"},Oe={class:"table"},De={class:"muted"},Fe={class:"muted"},D="https://script.google.com/macros/s/AKfycbw73aGzEMJBx0Aux32lqFVGI-hTzoGfQG_B9LvTHmhqxz7oS1RPSVMyXwlpMyDAqP6s/exec",Ue=F({__name:"AssassinHits",setup(V){const c={BASE_CHANCE:25,MACHETE_BONUS:25,ARMOR_PENALTY_NORMAL:45,ARMOR_PENALTY_TEACHER:75,SCALE_PENALTY:35,PENDANT_PENALTY:100,POISON_BONUS_PER_STACK:12.5,MIN_CHANCE:0,MAX_CHANCE:100},N=u([]),m=u(!1),d=u(null),p=u(""),h=u(""),y=u(null),b=u(null),v=ee({}),g=u(!0);let f=null;function _(s){if(typeof s=="boolean")return s;if(typeof s=="number")return s!==0;const e=String(s??"").trim().toLowerCase();return e==="true"||e==="yes"||e==="1"}function w(s,e=0){const t=Number(s);return Number.isFinite(t)?t:e}function q(){return new Date().toISOString()}function Y(s,e,t){return Math.max(e,Math.min(t,s))}function j(s){return s.day>0&&!!s.playerName?.trim()}async function G(){const s=await fetch("/data/season-2/role-widgets/assassinEffects.json",{cache:"no-store"});if(!s.ok)throw new Error("Failed to load assassinEffects.json");y.value=await s.json()}async function E(){m.value=!0,d.value=null;try{const s=new URL(D);s.searchParams.set("mode","list");const e=await fetch(s.toString(),{cache:"no-store"});if(!e.ok)throw new Error(`Sheet API failed (${e.status})`);const t=await e.json(),r=Array.isArray(t)?t:t.rows;if(!Array.isArray(r))throw new Error("Sheet API did not return rows[]");N.value=r.map(a=>({rowId:a.rowId??a.row??a.id,day:w(a.day),playerName:String(a.playerName??""),canRoll:_(a.canRoll),blacksmithArmor:_(a.blacksmithArmor),gleamingSardineScale:_(a.gleamingSardineScale),teacherBuff:_(a.teacherBuff),pendant:_(a.pendant),poisonAccumulated:w(a.poisonAccumulated),hitTimestamp:a.hitTimestamp?String(a.hitTimestamp):"",roll:a.roll!==void 0&&a.roll!==""?w(a.roll):void 0,success:a.success!==void 0&&a.success!==""?_(a.success):void 0,message:a.message?String(a.message):""}))}catch(s){d.value=s?.message??"Unknown error loading sheet"}finally{m.value=!1}}async function M(){await Promise.all([G(),E()])}const z=A(()=>{const s=w(p.value,0),e=h.value.trim().toLowerCase();return N.value.filter(t=>!(s>0&&t.day!==s||e&&!t.playerName.toLowerCase().includes(e)))}),S=A(()=>z.value.filter(s=>j(s)).sort((s,e)=>s.day-e.day)),k=A(()=>S.value.filter(s=>!s.hitTimestamp).sort((s,e)=>s.day-e.day)),P=A(()=>{const s=w(p.value,0);return s>0?s:S.value[0]?.day??1}),C=A(()=>{const s=y.value;return s?s[String(P.value)]??null:null});function K(s){const e=y.value?.[String(s.day)];let t=c.BASE_CHANCE;if(e?.MacheteFromHell&&(t+=c.MACHETE_BONUS),s.blacksmithArmor){const r=e?.teacherBuff?c.ARMOR_PENALTY_TEACHER:c.ARMOR_PENALTY_NORMAL;t-=r}return s.gleamingSardineScale&&(t-=c.SCALE_PENALTY),s.pendant&&(t-=c.PENDANT_PENALTY),t+=s.poisonAccumulated*c.POISON_BONUS_PER_STACK,e?.teacherBuff?100:Y(Math.round(t),c.MIN_CHANCE,c.MAX_CHANCE)}function X(s,e,t,r){return t?`ðŸ—¡ï¸ Assassination SUCCESS on ${s.playerName}. (Roll ${e} â‰¤ ${r}%)`:`ðŸ›¡ï¸ Assassination FAILED on ${s.playerName}. (Roll ${e} > ${r}%)`}async function J(s){const e=await fetch(D,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify({mode:"resolve",...s})});if(!e.ok)throw new Error(`Failed to write results (${e.status})`);return e.json().catch(()=>({}))}async function Q(s){if(s.canRoll&&!s.hitTimestamp){if(!s.rowId&&s.rowId!==0){d.value="Row is missing rowId. Make your API return rowId (sheet row number).";return}b.value=s.rowId;try{const e=K(s),t=Math.floor(Math.random()*100)+1,r=e===100?!0:t<=e,a=X(s,t,r,e),L=q();v[s.rowId]=`${a} @ ${L}`,await J({rowId:s.rowId,hitTimestamp:L,roll:t,success:r,message:a}),await E()}catch(e){d.value=e?.message??"Failed to resolve assassination"}finally{b.value=null}}}async function W(s){const e=v[s.rowId]||"";if(e)try{await navigator.clipboard.writeText(e)}catch{}}return se(g,s=>{f&&(window.clearInterval(f),f=null),s&&(f=window.setInterval(()=>E(),8e3))}),te(async()=>{await M(),g.value&&(f=window.setInterval(()=>E(),8e3))}),oe(()=>{f&&window.clearInterval(f)}),(s,e)=>(l(),n("div",ne,[o("header",le,[e[6]||(e[6]=o("h2",{class:"title"},"ðŸ—¡ï¸ Assassination Requests",-1)),e[7]||(e[7]=o("p",{class:"subtitle"}," Assassination Hub. Rolling is locked until The Game Host enables it. ",-1)),o("div",ie,[o("label",re,[e[3]||(e[3]=o("span",null,"Day",-1)),I(o("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>p.value=t),class:"input",type:"number",min:"1",placeholder:"e.g. 4"},null,512),[[H,p.value]])]),o("label",ce,[e[4]||(e[4]=o("span",null,"Player",-1)),I(o("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>h.value=t),class:"input",type:"text",placeholder:"filter by playerName"},null,512),[[H,h.value]])]),o("button",{class:"btn",onClick:M,disabled:m.value},[m.value?(l(),n("span",fe,"Loadingâ€¦")):(l(),n("span",de,"Refresh"))],8,ue),o("label",me,[I(o("input",{type:"checkbox","onUpdate:modelValue":e[2]||(e[2]=t=>g.value=t)},null,512),[[ae,g.value]]),e[5]||(e[5]=T(" Auto refresh ",-1))])]),d.value?(l(),n("p",_e,"âŒ "+i(d.value),1)):m.value?(l(),n("p",pe,"Loading requestsâ€¦")):(l(),n("p",he,"âœ… Loaded "+i(k.value.length)+" visible request(s)",1))]),C.value?(l(),n("section",ye,[o("h3",ve,"Assassin Effects (Day "+i(P.value)+")",1),o("ul",we,[o("li",null,[e[8]||(e[8]=o("b",null,"Teacher Buff:",-1)),T(" "+i(C.value.teacherBuff),1)]),o("li",null,[e[9]||(e[9]=o("b",null,"Machete From Hell:",-1)),T(" "+i(C.value.MacheteFromHell),1)])])])):R("",!0),o("section",Ae,[e[10]||(e[10]=o("h3",{class:"section-title"},"Requests",-1)),k.value.length===0?(l(),n("div",be," No requests found. ")):R("",!0),o("div",ge,[(l(!0),n(x,null,B(k.value,t=>(l(),n("article",{key:t.rowId,class:"card"},[o("div",Ee,[o("div",Re,[o("span",Ne,"Day "+i(t.day),1),o("span",Se,i(t.playerName),1),t.canRoll?(l(),n("span",Ce,"Ready")):(l(),n("span",ke,"Locked"))])]),o("div",Ie,[o("button",{class:"btn danger",onClick:r=>Q(t),disabled:b.value===t.rowId||!t.canRoll,title:t.canRoll?"":"Cannot roll until canRoll is TRUE"},[b.value!==t.rowId?(l(),n("span",Me,"Roll")):(l(),n("span",Pe,"Savingâ€¦"))],8,Te),o("button",{class:"btn ghost",onClick:r=>W(t),disabled:!v[t.rowId]}," Copy preview ",8,Le)]),t.canRoll?R("",!0):(l(),n("p",He," ðŸ”’ Waiting for Game Host ")),v[t.rowId]?(l(),n("p",xe,i(v[t.rowId]),1)):R("",!0)]))),128))])]),o("section",Be,[e[12]||(e[12]=o("h3",{class:"section-title"},"All Visible Rows",-1)),o("div",$e,[o("table",Oe,[e[11]||(e[11]=o("thead",null,[o("tr",null,[o("th",null,"Day"),o("th",null,"Player"),o("th",null,"Hit"),o("th",null,"Roll"),o("th",null,"Success"),o("th",null,"Message")])],-1)),o("tbody",null,[(l(!0),n(x,null,B(S.value,t=>(l(),n("tr",{key:t.rowId},[o("td",null,i(t.day),1),o("td",null,i(t.playerName),1),o("td",De,i(t.hitTimestamp||"â€”"),1),o("td",null,i(t.roll??"â€”"),1),o("td",null,i(t.success??"â€”"),1),o("td",Fe,i(t.message||"â€”"),1)]))),128))])])])])]))}}),Ve=U(Ue,[["__scopeId","data-v-d5a04702"]]),qe=F({name:"TheIslandHome",components:{navbar:Z,AssassinHits:Ve},mounted(){document.body.style.background="#000000"}}),Ye={class:"main-container"};function je(V,c,N,m,d,p){const h=O("navbar"),y=O("AssassinHits");return l(),n("div",null,[$(h),o("div",Ye,[$(y)])])}const Ke=U(qe,[["render",je]]);export{Ke as default};
